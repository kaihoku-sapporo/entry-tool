<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>搬入記録CSV出力ツール</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 5px; }
    input, select { margin: 5px; }
    .inline { display: inline-block; margin-right: 10px; }
    .action-btn { cursor: pointer; color: blue; text-decoration: underline; margin-left: 5px; }
    th.sortable { cursor: pointer; color: darkblue; }
  </style>
</head>
<body>
  <h2>搬入記録入力</h2>
  <div>
    <div class="inline">日付: <input type="date" id="date" onchange="updateWeekday()"></div>
    <div class="inline">曜日: <input type="text" id="weekday" readonly></div>
    <div class="inline">天気: 
      <select id="weather">
        <option value="晴">晴</option>
        <option value="曇">曇</option>
        <option value="雨">雨</option>
        <option value="雪">雪</option>
      </select>
    </div>
    <div class="inline">許可番号: <input type="text" id="permit" maxlength="4" oninput="autoFillCompany()"></div>
    <div class="inline">搬入社名: <input type="text" id="company"></div>
    <div>
      <span class="inline">車番: 札幌</span>
      <input type="text" id="plate_num1" size="4" maxlength="4" placeholder="1234">
      <input type="text" id="plate_kana" size="1" maxlength="1" placeholder="あ">
      <input type="text" id="plate_num2" size="4" maxlength="4" placeholder="5678">
    </div>
    <div class="inline">車種:
      <select id="type">
        <option value="10t">10t</option>
        <option value="8t">8t</option>
        <option value="4t">4t</option>
      </select>
    </div>
    <div class="inline">台数: <input type="number" id="count" min="1" value="1"></div>
    <button onclick="addEntry()">追加</button>
  </div>

  <h3>入力一覧（ヘッダークリックで並べ替え）</h3>
  <table id="table">
    <thead>
      <tr>
        <th class="sortable" onclick="sortTable(0)">日付</th>
        <th class="sortable" onclick="sortTable(1)">曜日</th>
        <th class="sortable" onclick="sortTable(2)">天気</th>
        <th class="sortable" onclick="sortTable(3)">許可番号</th>
        <th class="sortable" onclick="sortTable(4)">搬入社名</th>
        <th class="sortable" onclick="sortTable(5)">車番</th>
        <th class="sortable" onclick="sortTable(6)">車種</th>
        <th class="sortable" onclick="sortTable(7)">台数</th>
        <th class="sortable" onclick="sortTable(8)">立米数</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>合計</h3>
  <p id="totals"></p>
  <button onclick="downloadCSV()">CSVダウンロード</button>

  <script>
    const permitToCompany = {
      "5001": "清和建設株式会社",
      "5002": "道央建設工業株式会社",
      "5007": "丸高北進建設株式会社",
      "5008": "株式会社剛伸",
      "5009": "株式会社古田配管工業所",
      "5010": "協友建設工業株式会社",
      "5013": "丸宮藤田建設工業"
    };

    function autoFillCompany() {
      const permit = document.getElementById("permit").value;
      const companyInput = document.getElementById("company");
      companyInput.value = permitToCompany[permit] || "";
    }

    function updateWeekday() {
      const date = new Date(document.getElementById("date").value);
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      document.getElementById("weekday").value = weekdays[date.getDay()];
    }

    const entries = [];
    let sortDirection = true;

    function getCubicMeter(type, count) {
      const rates = { '10t': 6.0, '8t': 5.0, '4t': 2.0 };
      return rates[type] * count;
    }

    function addEntry() {
      const date = document.getElementById("date").value;
      const weekday = document.getElementById("weekday").value;
      const weather = document.getElementById("weather").value;
      const permit = document.getElementById("permit").value;
      const company = document.getElementById("company").value;
      const plate = `札幌 ${document.getElementById("plate_num1").value}${document.getElementById("plate_kana").value}${document.getElementById("plate_num2").value}`;
      const type = document.getElementById("type").value;
      const count = parseInt(document.getElementById("count").value);
      const m3 = getCubicMeter(type, count);

      const row = [date, weekday, weather, permit, company, plate, type, count, m3.toFixed(1)];
      entries.push(row);
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("table").querySelector("tbody");
      tbody.innerHTML = "";
      entries.forEach((row, index) => {
        const tr = document.createElement("tr");
        row.forEach(val => {
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        });
        const actionTd = document.createElement("td");
        const delBtn = document.createElement("span");
        delBtn.textContent = "削除";
        delBtn.className = "action-btn";
        delBtn.onclick = () => { entries.splice(index, 1); renderTable(); updateTotals(); };

        const editBtn = document.createElement("span");
        editBtn.textContent = "編集";
        editBtn.className = "action-btn";
        editBtn.onclick = () => loadEntry(index);

        actionTd.appendChild(editBtn);
        actionTd.appendChild(delBtn);
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
      updateTotals();
    }

    function loadEntry(index) {
      const row = entries[index];
      document.getElementById("date").value = row[0];
      updateWeekday();
      document.getElementById("weather").value = row[2];
      document.getElementById("permit").value = row[3];
      autoFillCompany();
      document.getElementById("company").value = row[4];
      const plate = row[5].replace('札幌 ', '');
      document.getElementById("plate_num1").value = plate.slice(0, plate.length - 5);
      document.getElementById("plate_kana").value = plate.slice(plate.length - 5, plate.length - 4);
      document.getElementById("plate_num2").value = plate.slice(plate.length - 4);
      document.getElementById("type").value = row[6];
      document.getElementById("count").value = row[7];
      entries.splice(index, 1);
      renderTable();
    }

    function updateTotals() {
      let total10t = 0, total8t = 0, total4t = 0;
      let totalM3 = 0;
      entries.forEach(([,,,,,, type, count, m3]) => {
        if (type === '10t') total10t += parseInt(count);
        if (type === '8t') total8t += parseInt(count);
        if (type === '4t') total4t += parseInt(count);
        totalM3 += parseFloat(m3);
      });
      document.getElementById("totals").textContent =
        `10t: ${total10t}台, 8t: ${total8t}台, 4t: ${total4t}台 / 合計立米数: ${totalM3.toFixed(1)} m3`;
    }

    function downloadCSV() {
      const today = document.getElementById("date").value || '搬入記録';
      let csv = '\uFEFF日付,曜日,天気,許可番号,搬入社名,車番,車種,台数,立米数\n';
      entries.forEach(row => {
        csv += row.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${today}.csv`;
      link.click();
    }

    function sortTable(index) {
      entries.sort((a, b) => {
        const valA = a[index];
        const valB = b[index];
        if (!isNaN(valA) && !isNaN(valB)) {
          return sortDirection ? valA - valB : valB - valA;
        }
        return sortDirection ? String(valA).localeCompare(valB, 'ja') : String(valB).localeCompare(valA, 'ja');
      });
      sortDirection = !sortDirection;
      renderTable();
    }
  </script>
</body>
</html>
