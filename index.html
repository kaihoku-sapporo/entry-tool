
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>搬入記録 入力フォーム</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
    .inline { display: flex; flex-direction: column; }
    input, select, button {
      padding: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .tabs {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #f0f0f0;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab-btn.active {
      background: #4285f4;
      color: white;
    }
  </style>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/jspdf-fonts@1.0.2/lib/japanese/noto.js"></script>

</head>
<body>
  <h2>搬入記録 入力フォーム</h2>
  <div class="form-grid">
    <div class="inline">日付: <input type="date" id="date" onchange="updateWeekday()" /></div>
    <div class="inline">曜日: <input type="text" id="weekday" readonly /></div>
    <div class="inline">天気:
      <select id="weather">
        <option value="晴">晴</option><option value="曇">曇</option><option value="雨">雨</option>
      </select>
    </div>
    <div class="inline">許可番号: <input type="text" id="permit" oninput="autoFillCompany()" /></div>
    <div class="inline">搬入社名: <input type="text" id="company" /></div>
    <div class="inline">車番: 札幌
      <input type="text" id="plate_num1" placeholder="1234" maxlength="4" />
      <input type="text" id="plate_kana" placeholder="あ" maxlength="1" />
      <input type="text" id="plate_num2" placeholder="5678" maxlength="4" />
    </div>
    <div class="inline">車種:
      <select id="type"><option>10t</option><option>8t</option><option>4t</option></select>
    </div>
    <div class="inline">台数: <input type="number" id="count" value="1" min="1" /></div>
  </div>
  <button onclick="addEntry()">追加</button>

  <h3>月別表示切替</h3>
  <div class="tabs" id="month-tabs"></div>

  <h3>日別表示切替</h3>
  <div class="tabs" id="day-tabs"></div>
  <button onclick="clearDayFilter()">すべてのデータを見る</button>

  <h3>搬入一覧</h3>
  <table>
    <thead>
      <tr>
        <th>日付</th><th>曜日</th><th>天気</th><th>許可番号</th><th>搬入社名</th>
        <th>車番</th><th>車種</th><th>台数</th><th>立米数</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

  <button onclick="downloadCSV()">CSV出力</button>
  <button onclick="downloadPDF()">PDF出力</button>

  <script>
    let permitToCompany = {};

fetch("permit_list.json")
  .then(res => res.json())
  .then(data => {
    permitToCompany = data;
  });

function autoFillCompany() {
  const permit = document.getElementById("permit").value;
  document.getElementById("company").value = permitToCompany[permit] || "";
}
    const months = ["2025-05", "2025-06", "2025-07", "2025-08", "2025-09", "2025-10", "2025-11"];
    let entries = JSON.parse(localStorage.getItem("entries") || "[]");
    let currentMonthFilter = "2025-05";
    let currentDayFilter = "";

    function autoFillCompany() {
      const permit = document.getElementById("permit").value;
      document.getElementById("company").value = permitToCompany[permit] || "";
    }
    function updateWeekday() {
      const date = new Date(document.getElementById("date").value);
      const days = ['日','月','火','水','木','金','土'];
      document.getElementById("weekday").value = days[date.getDay()];
    }
    function getCubicMeter(type, count) {
      const rates = { "10t": 6.0, "8t": 5.0, "4t": 2.0 };
      return rates[type] * count;
    }
    function saveToLocal() {
      localStorage.setItem("entries", JSON.stringify(entries));
    }
    function addEntry() {
      const date = document.getElementById("date").value;
      if (!date) return;
      const row = [
        date,
        document.getElementById("weekday").value,
        document.getElementById("weather").value,
        document.getElementById("permit").value,
        document.getElementById("company").value,
        `札幌 ${document.getElementById("plate_num1").value}${document.getElementById("plate_kana").value}${document.getElementById("plate_num2").value}`,
        document.getElementById("type").value,
        parseInt(document.getElementById("count").value),
        getCubicMeter(document.getElementById("type").value, parseInt(document.getElementById("count").value)).toFixed(1)
      ];
      entries.push(row);
      saveToLocal();
      renderTabs();
      renderTable();
  // Googleスプレッドシートに送信
fetch("https://script.google.com/macros/s/AKfycbzKo3zSkOYIfO7Te7gtQ4LJU3M4bD9sY2hwwQovY89JEcIXz01yLjYeE3In4nKYwpcX/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      date,
      weekday: document.getElementById("weekday").value,
      weather: document.getElementById("weather").value,
      permit: document.getElementById("permit").value,
      company: document.getElementById("company").value,
      plate: `札幌 ${document.getElementById("plate_num1").value}${document.getElementById("plate_kana").value}${document.getElementById("plate_num2").value}`,
      type: document.getElementById("type").value,
      count: parseInt(document.getElementById("count").value),
      cubic: getCubicMeter(document.getElementById("type").value, parseInt(document.getElementById("count").value)).toFixed(1)
    })
  }).then(res => res.text()).then(txt => console.log("GASレスポンス:", txt));

    }
    function renderTabs() {
      const monthTab = document.getElementById("month-tabs");
      const dayTab = document.getElementById("day-tabs");
      monthTab.innerHTML = "";
      dayTab.innerHTML = "";
      months.forEach(month => {
        const btn = document.createElement("button");
        btn.textContent = month.split('-')[1] + "月";
        btn.className = "tab-btn";
        if (month === currentMonthFilter) btn.classList.add("active");
        btn.onclick = () => { currentMonthFilter = month; currentDayFilter = ""; renderTabs(); renderTable(); };
        monthTab.appendChild(btn);
      });
      const days = [...new Set(entries.map(e => e[0]).filter(d => d.startsWith(currentMonthFilter)))];
      days.forEach(date => {
        const btn = document.createElement("button");
        btn.textContent = date.split("-")[2] + "日";
        btn.className = "tab-btn";
        if (date === currentDayFilter) btn.classList.add("active");
        btn.onclick = () => { currentDayFilter = date; renderTabs(); renderTable(); };
        dayTab.appendChild(btn);
      });
    }
    function clearDayFilter() {
      currentDayFilter = "";
      renderTabs();
      renderTable();
    }
    function renderTable() {
      const tbody = document.getElementById("table-body");
      tbody.innerHTML = "";
      entries.forEach((row, i) => {
        const [date] = row;
        if (date.startsWith(currentMonthFilter) && (currentDayFilter === "" || date === currentDayFilter)) {
          const tr = document.createElement("tr");
          row.forEach(val => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });
          const td = document.createElement("td");
          const btn = document.createElement("span");
          btn.textContent = "削除";
          btn.style.color = "blue";
          btn.style.cursor = "pointer";
          btn.onclick = () => {
            entries.splice(i, 1);
            saveToLocal();
            renderTabs();
            renderTable();
          };
          td.appendChild(btn);
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      });
    }
    
    
    
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // 正しいフォント登録と適用（文字化け防止）
      doc.addFileToVFS("NotoSansJP-Regular.ttf", window.jspdfNoto);
      doc.addFont("NotoSansJP-Regular.ttf", "NotoSansJP", "normal");
      doc.setFont("NotoSansJP");

      const inputDate = document.getElementById("date").value;
      if (!inputDate) {
        alert("日付を選択してください");
        return;
      }
      const dateObj = new Date(inputDate);
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdayNames[dateObj.getDay()];
      const weather = document.getElementById("weather")?.value || "";

      doc.setFontSize(14);
      doc.text(`${yyyy}年${mm}月${dd}日（${weekday}） 天気：${weather}`, 10, 15);

      const filteredEntries = entries.filter(e => {
        const date = e[0];
        return date.startsWith(currentMonthFilter) && (currentDayFilter === "" || date === currentDayFilter);
      });

      const tableData = filteredEntries.map(e => [
        e[3], e[4], e[5], e[6], e[7], e[8]
      ]);

      doc.autoTable({
        startY: 25,
        head: [["許可番号", "搬入社名", "車番", "車種", "台数", "立米数"]],
        body: tableData,
        styles: { fontSize: 10 },
        headStyles: { font: "NotoSansJP" },
        bodyStyles: { font: "NotoSansJP" }
      });

      doc.save(`${yyyy}${mm}${dd}_日報.pdf`);
    }
 {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // フォント登録（NotoSans）
      doc.addFileToVFS("NotoSansJP-Regular-normal.ttf", window.jspdfNoto);
      doc.addFont("NotoSansJP-Regular-normal.ttf", "NotoSansJP", "normal");
      doc.setFont("NotoSansJP");

      const inputDate = document.getElementById("date").value;
      if (!inputDate) {
        alert("日付を選択してください");
        return;
      }
      const dateObj = new Date(inputDate);
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdayNames[dateObj.getDay()];
      const weather = document.getElementById("weather")?.value || "";

      doc.setFontSize(14);
      doc.text(`${yyyy}年${mm}月${dd}日（${weekday}） 天気：${weather}`, 10, 15);

      const filteredEntries = entries.filter(e => {
        const date = e[0];
        return date.startsWith(currentMonthFilter) && (currentDayFilter === "" || date === currentDayFilter);
      });

      const tableData = filteredEntries.map(e => [
        e[3], e[4], e[5], e[6], e[7], e[8]
      ]);

      doc.autoTable({
        startY: 25,
        head: [["許可番号", "搬入社名", "車番", "車種", "台数", "立米数"]],
        body: tableData,
        styles: { fontSize: 10 }
      });

      doc.save(`${yyyy}${mm}${dd}_日報.pdf`);
    }
 {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdayNames[today.getDay()];
      const weather = document.getElementById("weather")?.value || "";

      doc.setFontSize(14);
      doc.text(`${yyyy}年${mm}月${dd}日（${weekday}） 天気：${weather}`, 10, 15);

      const filteredEntries = entries.filter(e => {
        const date = e[0];
        return date.startsWith(currentMonthFilter) && (currentDayFilter === "" || date === currentDayFilter);
      });

      const tableData = filteredEntries.map(e => [
        e[3], e[4], e[5], e[6], e[7], e[8]
      ]);

      doc.autoTable({
        startY: 25,
        head: [["許可番号", "搬入社名", "車番", "車種", "台数", "立米数"]],
        body: tableData,
        styles: { fontSize: 10 }
      });

      doc.save(`${yyyy}${mm}${dd}_日報.pdf`);
    }

    function downloadCSV() {
      let csv = "日付,曜日,天気,許可番号,搬入社名,車番,車種,台数,立米数\n";
      entries.forEach(e => {
        if (e[0]) csv += e.join(",") + "\n";
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = new Date().toISOString().slice(0, 10) + "_搬入記録.csv";
      link.click();
    }
    window.onload = () => { renderTabs(); renderTable(); };
  </script>
</body>
</html>
